<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>SmartEBS Snapshot Dashboard & Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h2>SmartEBS Snapshot Dashboard</h2>
    <p>APIë¥¼ í†µí•´ DynamoDB ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³  ìŠ¤ëƒ…ìƒ·/ì •ì±…ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
    <div class="controls">
      <button id="reloadBtn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </header>

  <main>
    <!-- í†µê³„ -->
    <section class="stats">
      <div class="stat-card">ì´ ìŠ¤ëƒ…ìƒ·: <span id="totalSnapshots">0</span></div>
      <div class="stat-card">ì§„í–‰ ì¤‘: <span id="inProgress">0</span></div>
      <div class="stat-card">ì™„ë£Œë¨: <span id="completed">0</span></div>
      <div class="stat-card">ì˜¤ë¥˜: <span id="failed">0</span></div>
    </section>

    <!-- ë ˆì´ì•„ì›ƒ: ì™¼ìª½(ê´€ë¦¬), ì˜¤ë¥¸ìª½(í‘œ) -->
    <section class="layout">
      <!-- ê´€ë¦¬ íŒ¨ë„ -->
      <aside class="panel">
        <h3>âš™ï¸ ìŠ¤ëƒ…ìƒ· ê´€ë¦¬</h3>
        <form id="createSnapshotForm" class="form-card">
          <h4>ğŸ“¸ ìŠ¤ëƒ…ìƒ· ìƒì„±</h4>
          <label>Volume ID
            <input type="text" name="volumeId" placeholder="vol-xxxxxxxxxxxxxxxxx" required />
          </label>
          <button type="submit">ìƒì„±</button>
          <small class="hint">ì˜ˆ: <code>vol-0340427802c1b5537</code></small>
        </form>

        <form id="deleteSnapshotForm" class="form-card">
          <h4>ğŸ—‘ï¸ ìŠ¤ëƒ…ìƒ· ì‚­ì œ</h4>
          <label>Snapshot ID
            <input type="text" name="snapshotId" placeholder="snap-xxxxxxxxxxxxxxxxx" required />
          </label>
          <button type="submit" class="danger">ì‚­ì œ</button>
        </form>

        <h3>ğŸ“‹ ì •ì±… ê´€ë¦¬</h3>
        <form id="createPolicyForm" class="form-card">
          <h4>â• ì •ì±… ì¶”ê°€</h4>
          <label>Policy Name
            <input type="text" name="name" placeholder="DailyBackup" required />
          </label>
          <label>Retention Days
            <input type="number" name="retentionDays" min="1" step="1" placeholder="7" required />
          </label>
          <button type="submit">ì¶”ê°€</button>
        </form>

        <form id="updatePolicyForm" class="form-card">
          <h4>âœï¸ ì •ì±… ìˆ˜ì •</h4>
          <label>Policy ID
            <input type="text" name="policy_id" placeholder="policy-xxxxxxxx" required />
          </label>
          <label>Policy Name (ì˜µì…˜)
            <input type="text" name="name" placeholder="ë³€ê²½í•  ì´ë¦„ (ì„ íƒ)" />
          </label>
          <label>Retention Days (ì˜µì…˜)
            <input type="number" name="retentionDays" min="1" step="1" placeholder="ì˜ˆ: 14" />
          </label>
          <button type="submit">ìˆ˜ì •</button>
        </form>

        <div id="toast" class="toast" hidden></div>
      </aside>

      <!-- ë°ì´í„° í‘œ -->
      <section class="tables">
        <div class="table-card">
          <h3>ğŸ“¸ Snapshots</h3>
          <div class="table-controls">
            <input type="text" id="filterInput" placeholder="Filter by snapshotId / volumeId" />
            <button id="reloadSnapshots">Reload</button>
          </div>
          <table id="snapshotsTable">
            <thead>
              <tr>
                <th>snapshotId</th>
                <th>volumeId</th>
                <th>status</th>
                <th>createdAt</th>
                <th>region</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="table-card">
          <h3>ğŸ“œ Policies</h3>
          <table id="policiesTable">
            <thead>
              <tr>
                <th>policy_id</th>
                <th>name</th>
                <th>retentionDays</th>
                <th>createdAt</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <footer>
    ìë™ ìƒˆë¡œê³ ì¹¨ ì£¼ê¸°: 5ë¶„ | SmartEBS Snapshot Manager Â© 2025
  </footer>

  <script>
    // ğŸ”— ì—¬ê¸°ë§Œ ì‹¤ì œ API Gateway URLë¡œ ë°”ê¿”ì£¼ì„¸ìš”
    const API_BASE = "https://8znjachaob.execute-api.ap-northeast-2.amazonaws.com/prod";


    // ==== ê³µí†µ ====
    function showToast(msg, type = "info") {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.className = `toast ${type}`;
      el.hidden = false;
      setTimeout(() => (el.hidden = true), 3000);
    }

    async function jsonFetch(url, options = {}) {
      const resp = await fetch(url, {
        headers: { "Content-Type": "application/json" },
        ...options,
      });
      const text = await resp.text();
      try {
        return { ok: resp.ok, status: resp.status, data: text ? JSON.parse(text) : {} };
      } catch {
        return { ok: resp.ok, status: resp.status, data: text };
      }
    }

    // ==== ì¡°íšŒ ====
    async function fetchSnapshots() {
      try {
        const { ok, data } = await jsonFetch(`${API_BASE}/list/snapshots`);
        const items = (data && (data.items || data.snapshots)) || [];
        renderSnapshots(items);
        updateStats(items);
      } catch (e) {
        console.error("âŒ Snapshot ë¡œë“œ ì‹¤íŒ¨:", e);
        showToast("ìŠ¤ëƒ…ìƒ· ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "error");
      }
    }

    async function fetchPolicies() {
      try {
        const { ok, data } = await jsonFetch(`${API_BASE}/list/policies`);
        const items = (data && (data.items || data.policies)) || [];
        renderPolicies(items);
      } catch (e) {
        console.error("âŒ Policy ë¡œë“œ ì‹¤íŒ¨:", e);
        showToast("ì •ì±… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "error");
      }
    }

    function renderSnapshots(snapshots) {
      const tbody = document.querySelector("#snapshotsTable tbody");
      tbody.innerHTML = "";
      if (!snapshots.length) {
        tbody.innerHTML = "<tr><td colspan='5'>ìŠ¤ëƒ…ìƒ· ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
        return;
      }

      const keyword = (document.getElementById("filterInput").value || "").trim().toLowerCase();
      snapshots
        .filter(s => {
          if (!keyword) return true;
          const hay = `${s.snapshotId ?? ""} ${s.volumeId ?? ""}`.toLowerCase();
          return hay.includes(keyword);
        })
        .forEach(s => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${s.snapshotId ?? "-"}</td>
            <td>${s.volumeId ?? "-"}</td>
            <td class="${(s.status || "").toLowerCase()}">${s.status ?? "-"}</td>
            <td>${s.createdAt ?? s.lastSyncedAt ?? "-"}</td>
            <td>${s.region ?? "-"}</td>
          `;
          tbody.appendChild(tr);
        });
    }

    function renderPolicies(policies) {
      const tbody = document.querySelector("#policiesTable tbody");
      tbody.innerHTML = "";
      if (!policies.length) {
        tbody.innerHTML = "<tr><td colspan='4'>ì •ì±… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
        return;
      }
      policies.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.policy_id ?? "-"}</td>
          <td>${p.name ?? "-"}</td>
          <td>${p.retentionDays ?? "-"}</td>
          <td>${p.createdAt ?? "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function updateStats(snapshots) {
      const total = snapshots.length;
      const inProgress = snapshots.filter(s => s.status === "creating").length;
      const completed = snapshots.filter(s => s.status === "completed").length;
      const failed = snapshots.filter(s => s.status === "error").length;

      document.getElementById("totalSnapshots").textContent = total;
      document.getElementById("inProgress").textContent = inProgress;
      document.getElementById("completed").textContent = completed;
      document.getElementById("failed").textContent = failed;
    }

    // ==== ê´€ë¦¬: ìŠ¤ëƒ…ìƒ· ====
    document.getElementById("createSnapshotForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const volumeId = e.target.volumeId.value.trim();
      if (!volumeId) return showToast("Volume IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "error");

      const { ok, data, status } = await jsonFetch(`${API_BASE}/create/snapshot`, {
        method: "POST",
        body: JSON.stringify({ volumeId }),
      });
      if (ok) {
        showToast(`ìŠ¤ëƒ…ìƒ· ìƒì„± ìš”ì²­ ì™„ë£Œ: ${data.snapshotId ?? ""}`, "success");
        fetchSnapshots();
        e.target.reset();
      } else {
        console.error("create snapshot error:", status, data);
        showToast("ìŠ¤ëƒ…ìƒ· ìƒì„± ì‹¤íŒ¨", "error");
      }
    });

    document.getElementById("deleteSnapshotForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const snapshotId = e.target.snapshotId.value.trim();
      if (!snapshotId) return showToast("Snapshot IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "error");

      const { ok, data, status } = await jsonFetch(`${API_BASE}/delete/snapshot`, {
        method: "POST",
        body: JSON.stringify({ snapshotId }),
      });
      if (ok) {
        showToast(`ìŠ¤ëƒ…ìƒ· ì‚­ì œ ìš”ì²­ ì™„ë£Œ: ${snapshotId}`, "success");
        fetchSnapshots();
        e.target.reset();
      } else {
        console.error("delete snapshot error:", status, data);
        showToast("ìŠ¤ëƒ…ìƒ· ì‚­ì œ ì‹¤íŒ¨", "error");
      }
    });

    // ==== ê´€ë¦¬: ì •ì±… ====
    document.getElementById("createPolicyForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = e.target.name.value.trim();
      const retentionDays = Number(e.target.retentionDays.value);
      if (!name || !retentionDays) return showToast("ì´ë¦„/ë³´ì¡´ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.", "error");

      const { ok, data, status } = await jsonFetch(`${API_BASE}/create/policy`, {
        method: "POST",
        body: JSON.stringify({ name, retentionDays }),
      });
      if (ok) {
        showToast(`ì •ì±… ìƒì„± ì™„ë£Œ: ${data.policy_id ?? name}`, "success");
        fetchPolicies();
        e.target.reset();
      } else {
        console.error("create policy error:", status, data);
        showToast("ì •ì±… ìƒì„± ì‹¤íŒ¨", "error");
      }
    });

    document.getElementById("updatePolicyForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const policy_id = e.target.policy_id.value.trim();
      const name = e.target.name.value.trim();
      const retentionDaysRaw = e.target.retentionDays.value;
      const body = { policy_id };
      if (name) body.name = name;
      if (retentionDaysRaw) body.retentionDays = Number(retentionDaysRaw);

      if (!policy_id) return showToast("Policy IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.", "error");

      const { ok, data, status } = await jsonFetch(`${API_BASE}/update/policy`, {
        method: "POST",
        body: JSON.stringify(body),
      });
      if (ok) {
        showToast(`ì •ì±… ìˆ˜ì • ì™„ë£Œ: ${policy_id}`, "success");
        fetchPolicies();
        e.target.reset();
      } else {
        console.error("update policy error:", status, data);
        showToast("ì •ì±… ìˆ˜ì • ì‹¤íŒ¨", "error");
      }
    });

    // ==== ì´ë²¤íŠ¸/ì´ˆê¸° ë¡œë“œ ====
    document.getElementById("reloadBtn").addEventListener("click", () => {
      fetchSnapshots();
      fetchPolicies();
    });
    document.getElementById("reloadSnapshots").addEventListener("click", fetchSnapshots);
    document.getElementById("filterInput").addEventListener("input", fetchSnapshots);

    window.addEventListener("DOMContentLoaded", () => {
      fetchSnapshots();
      fetchPolicies();
      setInterval(() => {
        fetchSnapshots();
        fetchPolicies();
      }, 300000); // 5ë¶„
    });
  </script>
</body>
</html>
